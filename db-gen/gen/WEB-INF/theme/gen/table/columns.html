<div ng-controller="columnsCtrl">
    <!-- #table -->
    <!-- #include('columns_table.html') -->
    <!-- #table -->

    <!-- #form -->
    <!-- #include('columns_form.html') -->
    <!-- #form -->
</div>

<script type="text/javascript">
    'use strict';
    function columnsCtrl($scope, $http) {
        angular.extend($scope, {
            // 初始化
            init: function() {
                $scope.initColumnForm();
                $scope.findColumns();
                $scope.findDialectType();
                $scope.findDictPosition();
            },

            // 初始化字段表单
            initColumnForm: function(column) {
                $scope.status('saveBtn', 'standby');
                $scope.status('deleteBtn', 'standby');
                $scope.isMoveColumn = false;
                $scope.columnFormData = {projectId: $scope.current.project.id, tableId: $scope.current.table.id, _request_type: 'json'};
                if (angular.isArray($scope.dialectTypes)) {
                    $scope.columnFormData.dialectType = $scope.dialectTypes[0];
                    $scope.changeDialectType();
                } if (angular.isArray($scope.positions)) {
                    $scope.columnFormData.position = $scope.positions[0].key;
                } if (angular.isDefined(column)) {
                    angular.extend($scope.columnFormData, column);
                    $scope.columnFormData.nullableBoolean = ($scope.columnFormData.nullable === '01');
                    $scope.checkDialectType();
                    $scope.deleteProps($scope.columnFormData, ['creator', 'createTime', 'updater', 'updateTime']);
                }
            },

            // 查询字段
            findColumns: function() {
                $http({
                    method: 'get',
                    url: '${app}/table/find_columns/' + $scope.current.table.id + '?_request_type=json'
                }).success(function(data) {
                    $scope.columns = data;
                });
            },

            // 查询方言类型
            findDialectType: function() {
                $http({
                    method: 'get',
                    url: '${app}/table/find_dialect_type/' + $scope.current.project.id + '?_request_type=json'
                }).success(function(data) {
                    $scope.dialectTypes = data;
                    $scope.columnFormData.dialectType = data[0];
                    $scope.changeDialectType();
                });
            },

            // 查询位置
            findDictPosition: function() {
                $http({
                    method: 'get',
                    url: '${app}/dicts/table_column_position'
                }).success(function(data) {
                    $scope.positions = data;
                    $scope.columnFormData.position = data[0].key;
                });
            },

            // 切换方言类型
            changeDialectType: function() {
                $scope.columnFormData.code = $scope.columnFormData.dialectType.prefix;
                $scope.columnFormData.dialectTypeId = $scope.columnFormData.dialectType.id;
                $scope.columnFormData.length = $scope.columnFormData.dialectType.length;
                $scope.columnFormData.precision = $scope.columnFormData.dialectType.precision;
                $scope.columnFormData.scale = $scope.columnFormData.dialectType.scale;
            },

            // 添加字典
            addDict: function() {
                if (angular.isUndefined($scope.columnFormData.tableColumnDicts)) {
                    $scope.columnFormData.tableColumnDicts = [];
                }
                $scope.columnFormData.tableColumnDicts.push($scope.dictFormData);
                $scope.dictFormData = {};
            },

            // 移除字典
            removeDict: function(dict) {
                $scope.removeFromArray(dict, $scope.columnFormData.tableColumnDicts, 'value');
            },

            // 初始化移动字段
            setupMoveColumns: function() {
                if ($scope.isMoveColumn) {
                    $scope.moveColumns = [];
                    angular.forEach($scope.columns, function(val) {
                        if (val.position === $scope.columnFormData.position && val.id !== $scope.columnFormData.id) {
                            $scope.moveColumns.push(val);
                        }
                    });
                    $scope.after = $scope.moveColumns[0];
                } else {
                    $scope.moveColumns = [];
                    $scope.after = undefined;
                }
            },

            // 保存字段
            save: function($event) {
                $scope.stop($event);
                $scope.status('saveBtn', 'processing');
                $scope.formData = angular.extend({}, $scope.columnFormData);
                $scope.formData.dicts = $scope.empty($scope.formData.tableColumnDicts) ? undefined : angular.toJson($scope.formData.tableColumnDicts);
                $scope.formData.nullable = $scope.formData.nullableBoolean ? '01' : '00';
                $scope.formData.order = $scope.isMoveColumn ? $scope.after.order + 1 : $scope.formData.order;
                $scope.formData.dialectType = {};
                $scope.formData.tableColumnDicts = [];
                if ($scope.empty($scope.formData.id)) {
                    $scope.create($scope.formData);
                } else {
                    $scope.update($scope.formData);
                }
            },

            // 新建字段
            create: function(data) {
                $http({
                    method: 'post',
                    url: '${app}/table/create_column',
                    data: jQuery.param(data)
                }).success(function(data) {
                    $scope.status('saveBtn', 'standby');
                    $scope.columns.push(data);
                    $scope.initColumnForm();
                });
            },

            // 更新字段
            update: function(data) {
                $http({
                    method: 'post',
                    url: '${app}/table/update_column/' + data.id,
                    data: jQuery.param(data)
                }).success(function(data) {
                    $scope.status('saveBtn', 'standby');
                    $scope.updateFromArray(data, $scope.columns);
                    $scope.initColumnForm();
                });
            },

            // 删除字段
            remove: function() {
                $scope.status('deleteBtn', 'processing');
                $http({
                    method: 'delete',
                    url: '${app}/table/delete_column/' + $scope.columnFormData.id
                }).success(function(data) {
                    $scope.removeFromArray(data, $scope.columns);
                    $scope.initColumnForm();
                    $scope.status('deleteBtn', 'standby');
                });
            },

            // 判断保存按钮是否有效
            disableSaveBtn: function() {
                if ($scope.columnForm.$invalid) return true;
                if ($scope.status('saveBtn', ['processing'])) return true;
                return false;
            },

            // 判断删除按钮是否有效
            disableDeleteBtn: function() {
                if ($scope.status('deleteBtn', ['processing'])) return true;
                return false;
            },

            // 隐藏字段
            hide: function(type) {
                if (angular.isUndefined($scope.columnFormData) || angular.isUndefined($scope.columnFormData.dialectType)) {
                    return;
                } else if (type === 'length') {
                    //return $scope.inArray($scope.columnFormData.dialectType.type, ['10']) >= 0;
                    return false;
                } else if (type === 'decimal') {
                    return $scope.inArray($scope.columnFormData.dialectType.type, ['10']) < 0;
                } else if (type === 'dict') {
                    return $scope.inArray($scope.columnFormData.dialectType.type, ['11']) < 0;
                }
            },

            // 选择确认字典类型
            checkDialectType: function() {
                angular.forEach($scope.dialectTypes, function(val) {
                    if (val.id === $scope.columnFormData.dialectTypeId) {
                        $scope.columnFormData.dialectType = val;
                    }
                });
            }
        }).init();
    }
</script>