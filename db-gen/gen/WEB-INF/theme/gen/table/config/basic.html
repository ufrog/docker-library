<div ng-controller="tableBasicCtrl">
    <div class="panel panel-default">
        <div class="panel-heading">基础设置</div>
        <div class="panel-body">
            <form name="tableBasicForm" method="post" action="#" class="form-horizontal" ng-submit="save($event)">
                <div class="form-group">
                    <label class="col-sm-2 control-label">库表前缀</label>
                    <div class="col-sm-2">
                        <input name="tablePrefix" type="text" class="form-control" ng-model="tableBasicFormData._pp_table_prefix">
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label">方言选择</label>
                    <div class="col-sm-4">
                        <select name="tableDialectId" class="form-control" ng-model="tableBasicFormData._pp_table_dialect_id" ng-options="dialect.id as dialect.name for dialect in dialects"></select>
                    </div>
                    <div class="col-sm-2">
                        <button type="button" class="btn btn-link"><i class="fa fa-cogs"></i> 管理</button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label">外键自动索引</label>
                    <div class="col-sm-4">
                        <p class="form-control-toggle"><toggle-switch bind="tableBasicFormData._pp_table_foreign_index" true="01" false="00"></toggle-switch></p>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label">模型包名</label>
                    <div class="col-sm-4">
                        <input name="tableEntityPackage" type="text" class="form-control" ng-model="tableBasicFormData._pp_table_entity_package">
                    </div>
                </div>
                <div class="form-group margin-bottom-zero">
                    <div class="col-sm-offset-2 col-sm-10">
                        <button class="btn btn-success" ng-disabled="disableSaveBtn()">
                            <span ng-show="status('saveBtn', ['standby'])"><i class="fa fa-floppy-o"></i> 保存</span>
                            <span ng-show="status('saveBtn', ['processing'])"><i class="fa fa-spinner fa-spin"></i> 正在保存配置...</span>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script type="text/javascript">
    'use strict';
    function tableBasicCtrl($scope, $http) {
        angular.extend($scope, {
            // 初始化
            init: function() {
                $scope.setupProp();
                $scope.findDialects();
                $scope.loadPrivateTable();
                $scope.status('saveBtn', 'standby');
            },

            // 设置属性
            setupProp: function() {
                $scope.tableBasicFormData = {};
                $scope.tableBasicFormData.projectId = $scope.current.project.id;
                $scope.tableBasicFormData._pp_table_prefix = $scope.current.project.props['table_prefix'];
                $scope.tableBasicFormData._pp_table_entity_package = $scope.current.project.props['table_entity_package'];
                $scope.tableBasicFormData._pp_table_foreign_index = $scope.current.project.props['table_foreign_index'];
                $scope.tableBasicFormData._pp_table_dialect_id = $scope.current.project.props['table_dialect_id'];
                $scope.tableBasicFormData._request_type = 'json';
            },

            // 查询所有方言
            findDialects: function() {
                $http({
                    method: 'get',
                    url: '${app}/table/config/find_dialect'
                }).success(function(data) {
                    $scope.dialects = data;
                    if ($scope.empty($scope.tableBasicFormData._pp_table_dialect_id)) {
                        $scope.tableBasicFormData._pp_table_dialect_id = $scope.dialects[0].id;
                    }
                });
            },

            // 查询私有库表
            loadPrivateTable: function() {
                $http({
                    method: 'get',
                    url: '${app}/table/config/find_table/' + $scope.current.project.id
                }).success(function(data) {
                    $scope.current.table = data;
                });
            },

            // 保存设置
            save: function($event) {
                $scope.stop($event);
                $scope.status('saveBtn', 'processing');
                $http({
                    method: 'post',
                    url: '${app}/project/config/save_prop',
                    data: jQuery.param($scope.tableBasicFormData)
                }).success(function(data) {
                    console.log(data);
                    $scope.status('saveBtn', 'standby');
                });
            },

            // 判断保存按钮是否有效
            disableSaveBtn: function() {
                if ($scope.status('saveBtn', ['processing'])) return true;
                return false;
            }
        }).init();
    }
</script>