<div ng-controller="indexesCtrl">
    <!-- #table -->
    <table class="table table-striped table-hover margin-bottom-zero">
        <colgroup>
            <col width="20%">
            <col width="15%">
            <col width="65%">
        </colgroup>
        <thead>
        <tr>
            <th>名称</th>
            <th>类型</th>
            <th>字段</th>
        </tr>
        </thead>
        <tbody>
        <tr ng-repeat="index in indexes">
            <td><a href="#" ng-click="initIndexForm(index)"><i class="fa fa-pencil-square-o"></i></a> <span ng-bind="index.name"></span></td>
            <td ng-bind="index.typeName"></td>
            <td>
                <span ng-repeat="column in index.tableIndexColumns"><span ng-bind="column.tableColumn.code"></span><br></span>
            </td>
        </tr>
        <tr ng-show="empty(indexes)">
            <td colspan="3" class="text-center">尚未添加索引</td>
        </tr>
        </tbody>
    </table>
    <!-- #table -->

    <!-- #form -->
    <div class="table-form">
        <form name="indexForm" method="post" action="#" class="form-horizontal" ng-submit="save($event)">
            <!-- #line first (name/type) -->
            <div class="form-group">
                <div class="col-sm-3">
                    <input name="name" type="text" class="form-control" placeholder="索引名称(必填)" ng-model="indexFormData.name" required>
                </div>
                <div class="col-sm-2">
                    <select name="type" class="form-control" ng-model="indexFormData.type" ng-options="type.key as type.value for type in types" required></select>
                </div>
            </div>
            <!-- #line first (name/type) -->

            <!-- #line second (columns) -->
            <div class="form-group" ng-show="!empty(indexFormData.columns)">
                <div class="col-sm-2" ng-repeat="column in indexFormData.columns">
                    <div class="input-group">
                        <input type="text" class="form-control" ng-model="column.name" readonly>
                        <div class="input-group-btn">
                            <button type="button" class="btn btn-danger" ng-click="removeColumn(column)"><i class="fa fa-times-circle"></i></button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <div class="col-sm-3">
                    <div class="input-group">
                        <select name="type" class="form-control" ng-model="column" ng-options="column.name for column in columns"></select>
                        <div class="input-group-btn">
                            <button type="button" class="btn btn-info" ng-click="addColumn()"><i class="fa fa-plus"></i> 添加</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- #line second (columns) -->

            <!-- #line third (button) -->
            <div class="form-group margin-bottom-zero">
                <div class="col-sm-12">
                    <button class="btn btn-success" ng-disabled="disableSaveBtn()">
                        <span ng-show="status('saveBtn', ['standby'])"><i class="fa fa-floppy-o"></i> 保存</span>
                        <span ng-show="status('saveBtn', ['processing'])"><i class="fa fa-spinner fa-spin"></i> 正在保存数据...</span>
                    </button>
                    <button type="button" class="btn btn-danger" ng-show="!empty(indexFormData.id)" ng-click="delete()" ng-disabled="disableDeleteBtn()">
                        <span ng-show="status('deleteBtn', ['standby'])"><i class="fa fa-times"></i> 删除</span>
                        <span ng-show="status('deleteBtn', ['processing'])"><i class="fa fa-spinner fa-spin"></i> 正在删除数据...</span>
                    </button>
                    <button type="button" class="btn btn-default" ng-show="!empty(indexFormData.id)" ng-click="initIndexForm()"><i class="fa fa-ban"></i> 取消</button>
                </div>
            </div>
            <!-- #line third (button) -->
        </form>
    </div>
    <!-- #form -->
</div>

<script type="text/javascript">
    'use strict';
    function indexesCtrl($scope, $http, $filter) {
        angular.extend($scope, {
            // 初始化
            init: function() {
                $scope.initIndexForm();
                $scope.findIndexes();
                $scope.findDictTypes();
                $scope.findColumns();
            },

            // 初始化索引表单
            initIndexForm: function(index) {
                $scope.status('saveBtn', 'standby');
                $scope.status('deleteBtn', 'standby');
                $scope.indexFormData = {projectId: $scope.current.project.id, tableId: $scope.current.table.id, columns: [], _request_type: 'json'};
                if (angular.isArray($scope.types)) {
                    $scope.indexFormData.type = $scope.types[0].key;
                } if (angular.isArray($scope.columns)) {
                    $scope.column = $scope.columns[0];
                } if (angular.isDefined(index)) {
                    angular.extend($scope.indexFormData, index);
                    $scope.putColumns();
                    $scope.deleteProps($scope.indexFormData, ['tableIndexColumns', 'creator', 'createTime', 'updater', 'updateTime']);
                }
            },

            // 查询库表索引
            findIndexes: function() {
                $http({
                    method: 'get',
                    url: '${app}/table/find_indexes/' + $scope.current.table.id + '?_request_type=json'
                }).success(function(data) {
                    $scope.indexes = data;
                });
            },

            // 查询字典类型
            findDictTypes: function() {
                $http({
                    method: 'get',
                    url: '${app}/dicts/table_index_type?_request_type=json'
                }).success(function(data) {
                    $scope.types = $filter('orderBy')(data, '-key');
                    $scope.indexFormData.type = $scope.types[0].key;
                });
            },

            // 查询库表字段
            findColumns: function() {
                $http({
                    method: 'get',
                    url: '${app}/table/find_columns/' + $scope.current.table.id + '?_request_type=json'
                }).success(function(data) {
                    $scope.columns = $filter('orderBy')(data, ['position','order']);
                    $scope.column = $scope.columns[0];
                });
            },

            // 添加字段
            addColumn: function() {
                $scope.indexFormData.columns.push($scope.column);
            },

            // 移除字段
            removeColumn: function(column) {
                $scope.removeFromArray(column, $scope.indexFormData.columns);
            },

            // 保存索引
            save: function($event) {
                $scope.stop($event);
                $scope.status('saveBtn', 'processing');
                $scope.setColumnIds();
                $scope.formData = angular.extend({}, $scope.indexFormData);
                $scope.formData.tableIndexColumns = [];
                $scope.deleteProps($scope.formData, 'columns');
                if ($scope.empty($scope.formData.id)) {
                    $scope.create($scope.formData);
                } else {
                    $scope.update($scope.formData);
                }
            },

            // 创建索引
            create: function(data) {
                $http({
                    method: 'post',
                    url: '${app}/table/create_index',
                    data: jQuery.param(data)
                }).success(function(data) {
                    $scope.status('saveBtn', 'standby');
                    $scope.indexes.push(data);
                    $scope.initIndexForm();
                });
            },

            // 更新索引
            update: function(data) {
                $http({
                    method: 'post',
                    url: '${app}/table/update_index/' + data.id,
                    data: jQuery.param(data)
                }).success(function(data) {
                    $scope.status('saveBtn', 'standby');
                    $scope.updateFromArray(data, $scope.indexes);
                    $scope.initIndexForm();
                });
            },

            // 删除索引
            delete: function() {
                $scope.status('deleteBtn', 'processing');
                $http({
                    method: 'delete',
                    url: '${app}/table/delete_index/' + $scope.indexFormData.id
                }).success(function(data) {
                    $scope.status('deleteBtn', 'standby');
                    $scope.removeFromArray(data, $scope.indexes);
                    $scope.initIndexForm();
                });
            },

            // 判断保存按钮是否有效
            disableSaveBtn: function() {
                if ($scope.indexForm.$invalid) return true;
                if ($scope.status('saveBtn', ['processing'])) return true;
                if ($scope.status('deleteBtn', ['processing'])) return true;
                return false;
            },

            // 判断删除按钮是否有效
            disableDeleteBtn: function() {
                if ($scope.status('saveBtn', ['processing'])) return true;
                if ($scope.status('deleteBtn', ['processing'])) return true;
                return false;
            },

            // 放置字段
            putColumns: function() {
                angular.forEach($scope.indexFormData.tableIndexColumns, function(val) {
                    $scope.indexFormData.columns.push(val.tableColumn);
                });
            },

            // 设置字段编号
            setColumnIds: function() {
                $scope.indexFormData.columnIds = [];
                angular.forEach($scope.indexFormData.columns, function(val) {
                    $scope.indexFormData.columnIds.push(val.id);
                });
            }
        }).init();
    }
</script>