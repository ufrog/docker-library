<div ng-controller="moduleCtrl">
    <div class="panel panel-default">
        <div class="panel-heading">模块选择</div>

        <!-- #modules -->
        <table class="table table-striped table-hover">
            <colgroup>
                <col width="0%">
                <col width="100%">
            </colgroup>
            <thead>
            <tr>
                <th><input type="checkbox" ng-model="allChecked" ng-click="checkAll()"></th>
                <th>模块名称</th>
            </tr>
            </thead>
            <tbody>
            <tr ng-repeat="module in modules">
                <td><input type="checkbox" ng-model="module.checked" ng-click="check(module)"></td>
                <td ng-bind="module.name"></td>
            </tr>
            </tbody>
        </table>
        <!-- #modules -->
    </div>
    <div class="table-footer">
        <button type="button" class="btn btn-success" ng-click="bind()" ng-disabled="disabledBindBtn()">
            <span ng-show="status('bindBtn', ['standby'])"><i class="fa fa-floppy-o"></i> 绑定</span>
            <span ng-show="status('bindBtn', ['processing'])"><i class="fa fa-spinner fa-spin"></i> 绑定中...</span>
        </button>
    </div>
</div>

<script type="text/javascript">
    'use strict';
    function moduleCtrl($scope, $http) {
        angular.extend($scope, {
            // 初始化
            init: function() {
                $scope.findModules();
                $scope.status('bindBtn', 'standby');
            },

            // 加载模块
            findModules: function() {
                $http({
                    method: 'get',
                    url: '${app}/project/config/modules/' + $scope.current.project.id
                }).success(function(data) {
                    $scope.modules = data;
                });
            },

            // 绑定模块
            bind: function() {
                $scope.status('bindBtn', 'processing');
                $scope.formData = {_request_type: 'json'};
                $scope.checkedIds();
                $http({
                    method: 'post',
                    url: '${app}/project/config/bind_modules/' + $scope.current.project.id,
                    data: jQuery.param($scope.formData)
                }).success(function(data) {
                    console.log(data);
                    $scope.status('bindBtn', 'standby');
                });
            },

            // 选中所有
            checkAll: function() {
                angular.forEach($scope.modules, function(val) {
                    val.checked = $scope.allChecked;
                });
            },

            // 处理已选中的内容
            checkedIds: function() {
                $scope.formData.moduleIds = [];
                angular.forEach($scope.modules, function(val) {
                    if (val.checked) {
                        $scope.formData.moduleIds.push(val.id);
                    }
                });
            },

            // 判断绑定按钮是否有效
            disabledBindBtn: function() {
                if ($scope.status('bindBtn', ['processing'])) return true;
                return false;
            }
        }).init();
    }
</script>